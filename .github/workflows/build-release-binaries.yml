name: Build release binaries

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install pak
        run: Rscript -e 'install.packages("pak", repos="https://cloud.r-project.org")'

      - name: Install package dependencies (from DESCRIPTION)
        run: Rscript -e 'pak::local_install_deps(dependencies = TRUE)'

      # If LSTbook is NOT on CRAN, add Remotes: in DESCRIPTION (recommended),
      # OR install it explicitly here and remove it from Imports.
      # - name: Install LSTbook from GitHub
      #   run: Rscript -e 'pak::pkg_install("OWNER/LSTbook")'

      - name: Build binary via R CMD INSTALL --build
        run: |
          Rscript -e 'dir.create("dist", showWarnings = FALSE)'
          Rscript -e 'system("R CMD INSTALL --build .")'
          Rscript -e 'files <- list.files(); files <- files[endsWith(files, c(".zip",".tgz",".tar.gz"))]; print(files); if (length(files)) file.copy(files, "dist", overwrite=TRUE)'
          Rscript -e 'print(list.files("dist"))'

      - name: Upload binaries to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.zip
            dist/*.tgz
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
